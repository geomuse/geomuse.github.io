---
layout: post
title:  forex 均值回归网格策略
date:   2025-02-28 11:01:30 +0800
categories: 
    - forex
    - 外汇策略
---

```c
//+------------------------------------------------------------------+
//|                                              MeanReversionGrid.mq4 |
//|                                     Copyright 2023, YourCompanyName |
//|                                             https://www.yoursite.com |
//+------------------------------------------------------------------+
#property copyright "Copyright 2023"
#property link      "https://www.yoursite.com"
#property version   "1.00"
#property strict

// 输入参数
input int    MA_Period = 50;          // 移动平均线周期
input ENUM_MA_METHOD MA_Method = MODE_SMA; // 均线类型
input double DeviationThreshold = 1.5; // 触发网格的偏差百分比
input double Lots = 0.1;              // 基础交易手数
input int    GridLevels = 5;          // 网格层数
input int    GridStep = 50;           // 网格间距(点)
input double TP_Ratio = 1.5;          // 止盈比例(相对于网格间距)
input double SL_Ratio = 3.0;          // 止损比例
input bool   EnableHedge = true;      // 允许对冲
input bool   UseEquityProtection = true; // 启用净值保护
input double MaxRiskPercent = 5.0;    // 最大风险百分比

// 全局变量
double maValue;
int magicNumber = 202310;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
{
   // 检查参数有效性
   if(GridLevels <= 0 || GridStep <= 0 || Lots <= 0)
   {
      Print("参数设置错误!");
      return(INIT_PARAMETERS_INCORRECT);
   }
   return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
{
   // 获取移动平均线值
   maValue = iMA(NULL,0,MA_Period,0,MA_Method,PRICE_CLOSE,0);
   
   // 计算当前价格与均线的偏差百分比
   double priceDeviation = (Bid - maValue) / maValue * 100;
   
   // 检查现有持仓
   int currentOrders = CountOrders();
   
   // 当没有持仓时检查入场条件
   if(currentOrders == 0)
   {
      // 做多条件：价格低于均线且偏差超过阈值
      if(Bid < maValue && MathAbs(priceDeviation) >= DeviationThreshold)
      {
         OpenGrid(OP_BUY);
      }
      // 做空条件：价格高于均线且偏差超过阈值
      else if(Ask > maValue && MathAbs(priceDeviation) >= DeviationThreshold)
      {
         OpenGrid(OP_SELL);
      }
   }
   else
   {
      ManageGrid();
   }
   
   // 净值保护
   if(UseEquityProtection)
   {
      EquityProtection();
   }
}

//+------------------------------------------------------------------+
//| 开仓网格函数                                                     |
//+------------------------------------------------------------------+
void OpenGrid(int cmd)
{
   double basePrice = (cmd == OP_BUY) ? Bid : Ask;
   double gridSize = GridStep * Point;
   
   for(int i=0; i<GridLevels; i++)
   {
      double price = 0;
      double sl = 0, tp = 0;
      double lotSize = Lots * (i+1); // 手数递增
      
      if(cmd == OP_BUY)
      {
         price = basePrice - i * gridSize;
         tp = price + (GridStep * TP_Ratio) * Point;
         sl = price - (GridStep * SL_Ratio) * Point;
      }
      else
      {
         price = basePrice + i * gridSize;
         tp = price - (GridStep * TP_Ratio) * Point;
         sl = price + (GridStep * SL_Ratio) * Point;
      }
      
      if(IsTradeAllowed())
      {
         OrderSend(Symbol(),cmd,lotSize,price,3,sl,tp,"MeanReversionGrid",magicNumber,0,clrNONE);
      }
   }
}

//+------------------------------------------------------------------+
//| 管理现有网格订单                                                 |
//+------------------------------------------------------------------+
void ManageGrid()
{
   for(int i=0; i<OrdersTotal(); i++)
   {
      if(OrderSelect(i,SELECT_BY_POS,MODE_TRADES))
      {
         if(OrderMagicNumber() == magicNumber && OrderSymbol() == Symbol())
         {
            // 检查是否触发止盈/止损
            double currentProfit = OrderProfit();
            
            // 当价格回归均线时平仓
            if((OrderType() == OP_BUY && Bid >= maValue) || 
               (OrderType() == OP_SELL && Ask <= maValue))
            {
               OrderClose(OrderTicket(),OrderLots(),OrderClosePrice(),3,clrNONE);
            }
         }
      }
   }
}

//+------------------------------------------------------------------+
//| 计算当前持仓数量                                                 |
//+------------------------------------------------------------------+
int CountOrders()
{
   int count = 0;
   for(int i=0; i<OrdersTotal(); i++)
   {
      if(OrderSelect(i,SELECT_BY_POS,MODE_TRADES))
      {
         if(OrderMagicNumber() == magicNumber && OrderSymbol() == Symbol())
         {
            count++;
         }
      }
   }
   return count;
}

//+------------------------------------------------------------------+
//| 净值保护函数                                                     |
//+------------------------------------------------------------------+
void EquityProtection()
{
   double equity = AccountEquity();
   double balance = AccountBalance();
   double risk = (balance - equity) / balance * 100;
   
   if(risk >= MaxRiskPercent)
   {
      CloseAllOrders();
      Print("触发净值保护，平仓所有订单");
   }
}

//+------------------------------------------------------------------+
//| 平仓所有订单                                                     |
//+------------------------------------------------------------------+
void CloseAllOrders()
{
   for(int i=OrdersTotal()-1; i>=0; i--)
   {
      if(OrderSelect(i,SELECT_BY_POS,MODE_TRADES))
      {
         if(OrderMagicNumber() == magicNumber && OrderSymbol() == Symbol())
         {
            if(OrderType() == OP_BUY || OrderType() == OP_SELL)
            {
               OrderClose(OrderTicket(),OrderLots(),OrderClosePrice(),3,clrNONE);
            }
            else
            {
               OrderDelete(OrderTicket());
            }
         }
      }
   }
}
//+------------------------------------------------------------------+
```