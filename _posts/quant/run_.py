import MetaTrader5 as mt5
import pandas as pd
import talib as ta
import time

# ËÆæÁΩÆÂèÇÊï∞
LOT_SIZE = 0.1  # ‰∫§ÊòìÊâãÊï∞
STOP_LOSS = 50  # Ê≠¢ÊçüÁÇπÊï∞
TAKE_PROFIT = 100  # Ê≠¢ÁõàÁÇπÊï∞
MAGIC_NUMBER = 101  # EA ËØÜÂà´ÁºñÂè∑

symbol = "XAUUSD"
# ÂàùÂßãÂåñ MT5
if not mt5.initialize():
    print("ÂàùÂßãÂåñÂ§±Ë¥•")
    quit()

# Ëé∑ÂèñÂéÜÂè≤Êï∞ÊçÆÂπ∂ËÆ°ÁÆó EMA
def get_ema(period, count=100):
    # Ëé∑ÂèñÂéÜÂè≤Êî∂Áõò‰ª∑
    rates = mt5.copy_rates_from_pos(symbol, mt5.TIMEFRAME_M1, 0, count)
    if rates is None:
        print("Ëé∑ÂèñÂéÜÂè≤Êï∞ÊçÆÂ§±Ë¥•")
        return None
    
    # Â∞ÜÊï∞ÊçÆËΩ¨Êç¢‰∏∫ DataFrame
    df = pd.DataFrame(rates)
    df['time'] = pd.to_datetime(df['time'], unit='s')
    
    # ËÆ°ÁÆó EMA
    df['ema'] = ta.EMA(df['close'], timeperiod=period)
    return df['ema'].iloc[-1]  # ËøîÂõûÊúÄÊñ∞ÁöÑ EMA ÂÄº

# Ê£ÄÊü•ÊòØÂê¶ÊúâÊåÅ‰ªì
def check_existing_orders():
    buy_exists = False
    sell_exists = False
    orders = mt5.orders_get()
    if orders is None:
        return False, False
    for order in orders:
        if order.magic == MAGIC_NUMBER:
            if order.type == mt5.ORDER_TYPE_BUY:
                buy_exists = True
            elif order.type == mt5.ORDER_TYPE_SELL:
                sell_exists = True
    return buy_exists, sell_exists

# ‰∫§ÊòìÈÄªËæë
def on_tick():
    ema50 = get_ema(50)
    ema200 = get_ema(200)
    price = mt5.symbol_info_tick(symbol).bid

    if ema50 is None or ema200 is None:
        return

    # Ê£ÄÊü•ÊòØÂê¶ÊúâÊåÅ‰ªì
    buy_exists, sell_exists = check_existing_orders()

    # ‰π∞ÂÖ•‰ø°Âè∑Ôºö50EMA ‰∏äÁ©ø 200EMA
    if ema50 > ema200 and not buy_exists:
        request = {
            "action": mt5.TRADE_ACTION_DEAL,
            "symbol": symbol,
            "volume": LOT_SIZE,
            "type": mt5.ORDER_TYPE_BUY,
            "price": price,
            "sl": price - STOP_LOSS * mt5.symbol_info(symbol).point,
            "tp": price + TAKE_PROFIT * mt5.symbol_info(symbol).point,
            "deviation": 10,
            "magic": MAGIC_NUMBER,
            "comment": "Buy Order",
            "type_time": mt5.ORDER_TIME_GTC,
            "type_filling": mt5.ORDER_FILLING_IOC,
        }
        result = mt5.order_send(request)
        if result.retcode != mt5.TRADE_RETCODE_DONE:
            print("‰π∞ÂÖ•ËÆ¢ÂçïÂ§±Ë¥•:", result.comment)

    # ÂçñÂá∫‰ø°Âè∑Ôºö50EMA ‰∏ãÁ©ø 200EMA
    if ema50 < ema200 and not sell_exists:
        request = {
            "action": mt5.TRADE_ACTION_DEAL,
            "symbol": mt5.symbol(),
            "volume": LOT_SIZE,
            "type": mt5.ORDER_TYPE_SELL,
            "price": price,
            "sl": price + STOP_LOSS * mt5.symbol_info(symbol).point,
            "tp": price - TAKE_PROFIT * mt5.symbol_info(symbol).point,
            "deviation": 10,
            "magic": MAGIC_NUMBER,
            "comment": "Sell Order",
            "type_time": mt5.ORDER_TIME_GTC,
            "type_filling": mt5.ORDER_FILLING_IOC,
        }
        result = mt5.order_send(request)
        if result.retcode != mt5.TRADE_RETCODE_DONE:
            print("ÂçñÂá∫ËÆ¢ÂçïÂ§±Ë¥•:", result.comment)

# ‰∏ªÂæ™ÁéØ
while True:
    on_tick()
    print('ü§ñ Bot Ê≠£Âú®ËøêË°å...')
    time.sleep(1)  # ÊØèÁßíÊ£ÄÊü•‰∏ÄÊ¨°